# Implementation Plan

Vertical slices — each slice is a working feature end-to-end.

---

## Slice 1: Spawn a session and see it

**Goal:** `scope spawn "task"` creates a tmux session with Claude Code, returns ID.

**Files:**
- `src/scope/core/session.py` — Session dataclass (minimal: id, task, state)
- `src/scope/core/state.py` — ensure_scope_dir, next_id, save_session
- `src/scope/core/tmux.py` — create_session only
- `src/scope/cli.py` — Click group
- `src/scope/commands/spawn.py` — spawn command

**Test:** Run `scope spawn "test"`, verify tmux session exists, `.scope/sessions/0/` created.

---

## Slice 2: Poll session status

**Goal:** `scope poll <id>` returns session state as JSON.

**Files:**
- `src/scope/core/state.py` — add load_session
- `src/scope/commands/poll.py` — poll command

**Test:** Spawn, then poll, see `{"status": "running"}`.

---

## Slice 3: Minimal TUI

**Goal:** `scope top` shows list of sessions, refreshes on file changes.

**Files:**
- `src/scope/core/state.py` — add load_all
- `src/scope/tui/app.py` — Basic Textual app
- `src/scope/tui/widgets/session_tree.py` — Simple list (not tree yet)

**Test:** Spawn a session, run `scope top`, see it listed. Spawn another, see it appear.

---

## Slice 4: Create session from TUI

**Goal:** Press `n` in TUI, spawns session in split pane.

**Files:**
- `src/scope/core/tmux.py` — add split_window
- `src/scope/tui/app.py` — action_new_session

**Test:** Run `scope top`, press `n`, see Claude Code appear in split pane.

---

## Slice 5: Attach to session from TUI

**Goal:** Press `enter` on session, opens split pane attached to it.

**Files:**
- `src/scope/tui/app.py` — action_attach

**Test:** Spawn session, `scope top`, select it, press enter, see it in split pane.

---

## Slice 6: Abort session

**Goal:** `scope abort <id>` and `x` in TUI kills session.

**Files:**
- `src/scope/core/tmux.py` — add kill_session
- `src/scope/core/state.py` — add update_state
- `src/scope/commands/abort.py` — abort command
- `src/scope/tui/app.py` — action_abort

**Test:** Spawn, abort, verify tmux session gone, state file says "aborted".

---

## Slice 7: Activity tracking via hooks

**Goal:** Hooks update activity file as Claude works.

**Files:**
- `src/scope/hooks/handler.py` — scope-hook command (activity event)
- `src/scope/hooks/install.py` — install_hooks function
- `src/scope/commands/setup.py` — setup command (just hooks for now)

**Test:** Run `scope setup`, spawn session, do something in Claude, see activity file update.

---

## Slice 8: Task inference from first message

**Goal:** Task file populated from user's first prompt.

**Files:**
- `src/scope/hooks/handler.py` — add task event handler

**Test:** Spawn session, type prompt, see task file updated with summary.

---

## Slice 9: Session completion detection

**Goal:** Stop hook marks session done/aborted based on result file.

**Files:**
- `src/scope/hooks/handler.py` — add stop event handler

**Test:** Complete a task in Claude (write result file), exit, see state="done".

---

## Slice 10: Wait for completion

**Goal:** `scope wait <id>` blocks until session completes.

**Files:**
- `src/scope/commands/wait.py` — wait command with watchfiles

**Test:** Spawn, `scope wait 0 &`, complete session, wait returns.

---

## Slice 11: Nested sessions

**Goal:** Claude can `scope spawn` to create child sessions.

**Files:**
- `src/scope/core/state.py` — next_id handles parent prefix
- `src/scope/core/session.py` — add parent field
- `src/scope/tui/widgets/session_tree.py` — tree view with hierarchy

**Test:** Spawn parent, inside it spawn child, see 0.0 in tree under 0.

---

## Slice 12: Contract generation

**Goal:** Spawned sessions get injected contract.

**Files:**
- `src/scope/core/contract.py` — generate_contract

**Test:** Spawn with `--input`, verify contract.md has correct content.

---

## Slice 13: Setup with tmux check

**Goal:** `scope setup` checks for tmux, offers to install.

**Files:**
- `src/scope/core/tmux.py` — add is_installed
- `src/scope/commands/setup.py` — tmux check logic

---

## Slice 14: Polish TUI

**Goal:** Keyboard navigation, expand/collapse, hide done.

**Files:**
- `src/scope/tui/app.py` — remaining keybindings
- `src/scope/tui/widgets/session_tree.py` — expand/collapse state

---

## Summary

| Slice | Feature | E2E Test |
|-------|---------|----------|
| 1 | spawn | Creates tmux + files |
| 2 | poll | Returns status JSON |
| 3 | top (basic) | Shows sessions |
| 4 | new from TUI | Split pane opens |
| 5 | attach | Split pane to existing |
| 6 | abort | Kills session |
| 7 | activity hooks | Live activity updates |
| 8 | task inference | Task from first message |
| 9 | completion | Done/aborted on exit |
| 10 | wait | Blocks until done |
| 11 | nesting | Parent/child sessions |
| 12 | contracts | Injected prompts |
| 13 | setup | tmux check + hooks |
| 14 | TUI polish | Full keybindings |

Start with Slice 1. Each slice is testable independently.
